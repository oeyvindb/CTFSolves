#Solution to MalwareTech shellcode challenge 1
#Made by: Oyvind

import binaryninja

ADDRESS_FLAG=0x404040 #The flag is encrypted at this address

rol = lambda val, r_bits, max_bits: \
(val << r_bits%max_bits) & (2**max_bits-1) | \
((val & (2**max_bits-1)) >> (max_bits-(r_bits%max_bits)))
 
ror = lambda val, r_bits, max_bits: \
((val & (2**max_bits-1)) >> r_bits%max_bits) | \
(val << (max_bits-(r_bits%max_bits)) & (2**max_bits-1))
  
max_bits=8

def main():
    print "Solution for MalwareTech shellcode challenge 1!"
    bv=binaryninja.BinaryViewType["PE"].open("shellcode1.exe_")
    bv.update_analysis_and_wait()
    br=binaryninja.BinaryReader(bv)
    br.seek(ADDRESS_FLAG)
    flag=""

    #Read encoded characters and decode them with rol 5
    while True:
        enc_char=br.read8()
        if enc_char == 0:
            break
        flag+=chr(rol(enc_char,5,max_bits))

    print "The flag is: %s " % flag

if __name__=="__main__":
    main()
